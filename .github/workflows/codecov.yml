name: CodeCov workflow

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Test Ruscode and Upload to CodeCov
    steps:
    - uses: actions/checkout@v3
    # nice reusable workflow to get rust ready
    - name: Setup rust toolchain
      uses: hecrj/setup-rust-action@master
      with:
        rust-version: stable
        components: "clippy, rustfmt"
    - name: Run cargo test and Collect coverage
      env:
        RUSTFLAGS: -Cinstrument-coverage
        LLVM_PROFILE_FILE: ruscode-%p-%m.profraw
      run: |
        cargo test
        grcov . --binary-path ./target/debug/ -s . -t html --branch --ignore-not-existing -o ./coverage/

    - name: Upload coverage reports to Codecov with GitHub Action
      uses: codecov/codecov-action@v3
      with:
        directory: ./coverage/